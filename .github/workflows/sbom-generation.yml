name: SBOM Generation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

env:
  FORCE_COLOR: 1

jobs:
  generate-sbom:
    name: Generate Software Bill of Materials
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      actions: read
      
    steps:
      - name: 🔖 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 📦 Install dependencies
        run: npm ci
        
      - name: 🔧 Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft version
          
      - name: 📋 Generate SBOM with Syft
        run: |
          chmod +x .github/scripts/generate-sbom.sh
          .github/scripts/generate-sbom.sh
          
      - name: ✅ Validate SBOM
        run: |
          chmod +x .github/scripts/validate-sbom.sh
          .github/scripts/validate-sbom.sh
          
      - name: 📊 Generate metadata
        run: |
          cat > ./sbom/generation-metadata.json << EOF
          {
            "generation": {
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "workflow_run_id": "${{ github.run_id }}",
              "commit_sha": "${{ github.sha }}",
              "ref": "${{ github.ref }}"
            },
            "tools": {
              "syft": "$(syft version --output json | jq -r '.version')",
              "node": "$(node --version)",
              "npm": "$(npm --version)"
            },
            "project": {
              "name": "dedication-portfolio",
              "version": "$(jq -r '.version' package.json)",
              "repository": "${{ github.repository }}"
            }
          }
          EOF
          
      - name: 📁 List generated files
        run: |
          echo "Generated SBOM files:"
          ls -la ./sbom/
          echo ""
          echo "File sizes:"
          du -h ./sbom/*
          
      - name: 📤 Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-files-${{ github.run_id }}
          path: ./sbom/
          retention-days: 90
          compression-level: 6
          
      - name: 📈 Upload to GitHub dependency graph
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: advanced-security/maven-dependency-submission-action@v3
        continue-on-error: true
        with:
          directory: ./sbom
          
      - name: 💾 Commit SBOM files to repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add SBOM files
          git add ./sbom/sbom-final.spdx.json
          git add ./sbom/sbom-final.cyclonedx.json
          git add ./sbom/validation-report.txt
          git add ./sbom/generation-metadata.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No SBOM changes to commit"
          else
            git commit -m "chore: update SBOM files [skip ci]

            - Updated SPDX and CycloneDX SBOM files
            - Generated by GitHub Actions workflow
            - Commit: ${{ github.sha }}
            - Run ID: ${{ github.run_id }}"
            git push
          fi
          
      - name: 📋 Summary
        run: |
          echo "## 📋 SBOM Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ SBOM generation completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | Format |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| sbom-final.spdx.json | $(du -h ./sbom/sbom-final.spdx.json | cut -f1) | SPDX 2.3 |" >> $GITHUB_STEP_SUMMARY
          echo "| sbom-final.cyclonedx.json | $(du -h ./sbom/sbom-final.cyclonedx.json | cut -f1) | CycloneDX 1.6 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Counts" >> $GITHUB_STEP_SUMMARY
          echo "- **SPDX Packages**: $(jq '.packages | length' ./sbom/sbom-final.spdx.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **CycloneDX Components**: $(jq '.components | length' ./sbom/sbom-final.cyclonedx.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY